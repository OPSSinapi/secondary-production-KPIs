<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinapi Biomedical Operations Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
    :root {
        --primary-blue: #3498db;
        --primary-dark-blue: #2980b9;
        --primary-orange: #f39c12;
        --primary-purple: #9b59b6;
        --text-dark: #2c3e50;
        --text-light: #7f8c8d;
        --border-color: #ecf0f1;
        --timeline-blue: #3498db;
        --timeline-orange: #e67e22;
        --timeline-red: #e74c3c;
        --timeline-purple: #9b59b6;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --danger-color: #c0392b;
        --active-bg: #eafaf1;
        --standby-bg: #fef9e7;
        --error-bg: #fdeaea;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
        color: var(--text-dark);
    }

    /* Header styles */
    .header {
        background-color: var(--primary-dark-blue);
        color: white;
        padding: 0 20px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .header h1 {
        font-size: 20px;
    }

    .date-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .date-filter {
        background-color: rgba(255, 255, 255, 0.2);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 14px;
    }

    .date-range-btn, .period-btn, .refresh-btn {
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 12px;
    }

    .refresh-btn {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Date picker dropdown */
    .date-picker-dropdown {
        position: absolute;
        top: 60px;
        right: 20px;
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 15px;
        z-index: 999;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        display: none;
        width: 320px;
    }

    .date-picker-dropdown.show {
        display: block;
    }

    .date-picker-dropdown label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .date-picker-dropdown input[type="date"] {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
    }

    .date-picker-dropdown button {
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 3px;
        padding: 8px 15px;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
    }

    .cycle-selection {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
    }

    .cycle-selection select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
    }
        /* KPI Summary */
    .kpi-summary {
        background-color: white;
        border-radius: 5px;
        margin: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .kpi-summary-label {
        padding: 10px 15px;
        font-size: 16px;
        font-weight: bold;
        border-bottom: 1px solid var(--border-color);
    }

    .kpi-cards {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        padding: 10px;
        gap: 10px;
    }

    .kpi-card {
        flex: 1;
        min-width: 180px;
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .kpi-title {
        font-size: 14px;
        color: var(--text-light);
        margin-bottom: 10px;
    }

    .kpi-value {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .kpi-value-number {
        font-size: 22px;
        font-weight: bold;
    }

    .kpi-trend {
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .trend-up {
        color: var(--success-color);
    }

    .trend-down {
        color: var(--danger-color);
    }

    /* Loading spinner */
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        height: 200px;
        width: 100%;
    }

    .loading-spinner {
        border: 5px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 5px solid var(--primary-blue);
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
/* 
        ======================================
        MAIN DASHBOARD GRID
        ======================================
        */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: auto auto;
            gap: 10px;
            padding: 0 15px;
            margin-bottom: 15px;
        }

        /* 
        ======================================
        LINE CARDS
        ======================================
        */
        .line-card {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .line-card-header {
            padding: 5px 15px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-actions {
            display: flex;
            align-items: center;
        }

        .enlarge-icon {
            cursor: pointer;
            margin-left: 8px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .enlarge-icon:hover {
            opacity: 1;
        }

        .blue-header {
            background-color: var(--primary-blue);
        }

        .orange-header {
            background-color: var(--primary-orange);
        }

        .purple-header {
            background-color: var(--primary-purple);
        }

        .line-card-content {
            padding: 10px 15px;
        }
        .variant-info {
            background-color: #f5f7fa;
            border-radius: 3px;
            padding: 5px 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 30px;
        }

        .variant-label {
            font-size: 12px;
            color: var(--text-dark);
        }

        .variant-name {
            font-weight: bold;
            margin-left: 5px;
        }

        .status-badge {
            border-radius: 5px;
            padding: 2px 10px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            width: 70px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-active {
            background-color: var(--active-bg);
            color: var(--success-color);
        }

        .status-standby {
            background-color: var(--standby-bg);
            color: var(--warning-color);
        }

        .status-ended {
            background-color: var(--standby-bg);
            color: var(--warning-color);
        }

        /* 
        ======================================
        VARIANT HISTORY
        ======================================
        */
        .variant-history {
            background-color: #f5f7fa;
            border-radius: 3px;
            padding: 5px 10px;
            margin-bottom: 10px;
            height: 60px;
        }

        .history-label {
            font-size: 11px;
            font-weight: bold;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .timeline-container {
            background-color: white;
            border-radius: 2px;
            padding: 5px;
            height: 25px;
            position: relative;
        }

        /* 
        ======================================
        COMBINED VARIANT DISPLAY
        ======================================
        */
        .variant-combined {
            background-color: #f5f7fa;
            border-radius: 3px;
            padding: 5px 10px;
            margin-bottom: 10px;
        }

        .variant-combined .variant-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 30px;
        }

        .variant-combined .timeline-container {
            height: 20px;
            padding: 2px;
        }

        .timeline-segment {
            position: absolute;
            height: 15px;
            top: 5px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
        }

        /* 
        ======================================
        EXPLICIT GRID POSITIONING
        ======================================
        */
        .grid-position-1-1 { grid-row: 1; grid-column: 1; }
        .grid-position-1-2 { grid-row: 1; grid-column: 2; }
        .grid-position-1-3 { grid-row: 1; grid-column: 3; }
        .grid-position-1-4 { grid-row: 1; grid-column: 4; }
        .grid-position-2-1 { grid-row: 2; grid-column: 1; }
        .grid-position-2-2 { grid-row: 2; grid-column: 2; }
        .grid-position-2-3 { grid-row: 2; grid-column: 3; }
        .grid-position-2-4 { grid-row: 2; grid-column: 4; }

        /* 
        ======================================
        KPI METRICS GRID
        ======================================
        */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .metric-card {
            background-color: #f5f7fa;
            border-radius: 3px;
            padding: 10px;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .metric-title {
            font-size: 12px;
            color: var(--text-dark);
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
        }

        .metric-trend {
            font-size: 12px;
        }

        .value-good {
            color: var(--success-color);
        }

        .value-warning {
            color: var(--warning-color);
        }

        .value-danger {
            color: var(--danger-color);
        }
        /* 
        ======================================
        DIVIDER
        ======================================
        */
        .divider {
            height: 2px;
            background-color: var(--border-color);
            margin: 10px 0;
        }

        /* 
        ======================================
        TABLE FOR POPUP LINE
        ======================================
        */
        .runs-table-container {
            background-color: #f5f7fa;
            border-radius: 3px;
            padding: 10px;
            margin-top: 10px;
        }

        .runs-table-title {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .runs-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 5px;
        }

        .runs-table th {
            background-color: #ecf0f1;
            padding: 5px;
            text-align: left;
            font-size: 10px;
            color: var(--text-light);
            border-radius: 2px;
        }

        .runs-table td {
            background-color: white;
            padding: 5px;
            font-size: 10px;
            border-radius: 2px;
        }

        /* 
        ======================================
        ERROR MESSAGE
        ======================================
        */
        .error-message {
            background-color: var(--error-bg);
            color: var(--danger-color);
            padding: 15px;
            margin: 10px 15px;
            border-radius: 5px;
            text-align: center;
        }

        /* 
        ======================================
        DEBUG LOG
        ======================================
        */
        .debug-log {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin: 10px 15px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .debug-log-entry {
            margin-bottom: 5px;
            padding: 3px;
            border-bottom: 1px solid #eee;
        }

        .debug-log-entry.error {
            color: var(--danger-color);
            font-weight: bold;
        }

        .debug-log-entry.warning {
            color: var(--warning-color);
        }

        .debug-log-entry.info {
            color: var(--text-dark);
        }
        
        /* 
        ======================================
        MODAL / DETAIL VIEW
        ======================================
        */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        /* Improved Modal Styling */
        .modal-content {
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1600px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 15px 20px;
            background-color: var(--primary-dark-blue);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            font-size: 22px;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            padding: 15px 20px;
        }
        /* REDESIGNED DETAIL VIEW STYLES */
        
        /* Main detail metrics layout */
        .detail-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: auto auto auto;
            gap: 15px;
            height: calc(100% - 60px); /* Subtract date nav height */
        }
        
        /* Card positioning and sizing for redesigned layout */
        .schedule-card { 
            grid-column: 1; 
            grid-row: 1; 
            height: 140px; 
        }
        
        .labour-card { 
            grid-column: 2; 
            grid-row: 1; 
            height: 140px; 
        }
        
        .scrap-card { 
            grid-column: 1 / span 2; 
            grid-row: 2; 
            height: 200px; 
        }
        
        .downtime-card { 
            grid-column: 1 / span 2; 
            grid-row: 3; 
            height: 110px; 
        }
        
        /* Detail-specific card styling */
        .detail-metric-card {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 12px;
        }
        
        .detail-metric-header {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        /* Toggle buttons styling */
        .toggle-container {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .toggle-btn {
            background-color: #e8e8e8;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .toggle-btn.active {
            background-color: var(--primary-blue);
            color: white;
        }
        
        /* Chart containers with consistent heights */
        .chart-container {
            flex: 1;
            position: relative;
            min-height: 0;
            background-color: #ffffff;
            border-radius: 4px;
        }
        
        .schedule-card .chart-container,
        .labour-card .chart-container {
            height: 80px !important;
            min-height: 80px !important;
        }
        
        .downtime-card .chart-container {
            height: 60px !important;
            min-height: 60px !important;
        }
        
        /* Scrap Analysis Layout */
        .scrap-analysis-layout {
            display: flex;
            flex-direction: column;
            height: calc(100% - 45px); /* Subtract header and toggle height */
        }
        
        .scrap-trend-chart {
            flex: 0 0 50px;
            margin-bottom: 10px;
            background-color: #f5f7fa;
            border-radius: 4px;
            padding: 5px;
        }
        
        .chart-subtitle {
            font-size: 11px;
            color: var(--text-dark);
            margin-bottom: 2px;
        }
        
        .daily-scrap-container {
            flex: 1;
            overflow-y: auto;
        }
        
        .daily-scrap-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        /* Scrap daily card styling */
        .daily-scrap-card {
            background-color: #f5f7fa;
            border-radius: 4px;
            padding: 8px;
            min-height: 70px;
        }
        
        .daily-scrap-header {
            font-size: 10px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 4px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 2px;
        }
        
        .scrap-reason {
            font-size: 8px;
            line-height: 1.3;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Downtime styling */
        .downtime-label {
            font-size: 8px;
            color: var(--text-light);
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
            margin-bottom: 2px;
        }
        /* 
        ======================================
        DATE NAVIGATION
        ======================================
        */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            background-color: white;
            border-radius: 6px;
            padding: 10px 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .date-range-display {
            font-size: 15px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .date-nav-controls {
            display: flex;
            gap: 10px;
        }

        .date-nav-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            min-width: 150px; /* Increased min-width to prevent text cutoff */
            justify-content: center; /* Center content in button */
            white-space: nowrap; /* Prevent text wrapping */
        }

        .date-nav-btn:hover {
            background-color: #2980b9;
        }

        /* 
        ======================================
        RESPONSIVE LAYOUTS
        ======================================
        */
        /* Special Cases */
        .card-double-height {
            grid-row: span 2;
        }

        /* Base product line cards in same column */
        .base-product-first {
            grid-column-start: var(--column-start);
        }

        .base-product-same-column {
            grid-column-start: var(--column-start);
        }

        @media (max-width: 1279px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .card-double-height {
                grid-column: span 1;
            }
            
            .detail-metrics {
                grid-template-columns: 1fr;
            }
            
            .schedule-card, .labour-card {
                grid-column: 1;
            }
            
            .scrap-card, .downtime-card {
                grid-column: 1;
            }
            
            .labour-card {
                grid-row: 2;
            }
            
            .scrap-card {
                grid-row: 3;
            }
            
            .downtime-card {
                grid-row: 4;
            }
            
            .daily-scrap-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 767px) {
            .header {
                flex-direction: column;
                height: auto;
                padding: 10px;
            }
            
            .date-controls {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
            
            .kpi-cards {
                flex-direction: column;
                height: auto;
                gap: 5px;
            }
            
            .kpi-summary {
                height: auto;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                max-height: 95vh;
            }
            
            .modal-title {
                font-size: 16px;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .daily-scrap-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Header Section -->
    <header class="header">
        <h1>Sinapi Biomedical Operations Dashboard</h1>
        <div class="date-controls">
            <button class="date-nav-btn" id="prevPeriodButton"><i class="fas fa-chevron-left"></i></button>
            <div class="date-filter" id="dateRangeDisplay">Loading...</div>
            <button class="date-nav-btn" id="nextPeriodButton"><i class="fas fa-chevron-right"></i></button>
            <button class="date-range-btn" id="dateRangeButton">Select Dates</button>
            <button class="period-btn" id="periodToggle">Weekly</button>
            <button class="refresh-btn" id="refreshButton"><i class="fas fa-sync-alt"></i></button>
        </div>
    </header>
    <!-- Date Range Picker Dropdown -->
    <div class="date-picker-dropdown" id="datePickerDropdown">
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate" name="startDate">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate" name="endDate">
        
        <div class="cycle-selection">
            <label for="cycleStartDay">Select Week Cycle:</label>
            <select id="cycleStartDay">
                <option value="1">Monday to Sunday</option>
                <option value="2">Tuesday to Monday</option>
                <option value="3">Wednesday to Tuesday</option>
                <option value="4">Thursday to Wednesday</option>
                <option value="5">Friday to Thursday</option>
                <option value="6">Saturday to Friday</option>
                <option value="0">Sunday to Saturday</option>
            </select>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button id="applyDateRange" style="flex: 1;">Apply</button>
                <button id="applyAndRememberCycle" style="flex: 1; background-color: var(--primary-dark-blue);">Apply & Remember</button>
            </div>
        </div>
    </div>

    <!-- KPI Summary Section -->
    <div class="kpi-summary">
        <div class="kpi-summary-label">Plant-wide Performance</div>
        <div class="kpi-cards" id="kpiSummary">
            <!-- KPI cards will be inserted here by JavaScript -->
            <div class="loading-container">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>
    
    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid" id="dashboardGrid">
        <!-- Loading spinner initially -->
        <div class="loading-container">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Debug Log (hidden by default) -->
    <div class="debug-log" id="debugLog" style="display: none;">
        <div class="debug-log-entry info">Debug log initialized.</div>
    </div>

    <!-- Detail View Modal with Redesigned Layout -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">SCD: Apelele Details</div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Date Navigation -->
                <div class="date-nav">
                    <div class="date-range-display" id="modalDateRange">March 18-25, 2025</div>
                    <div class="date-nav-controls">
                        <button class="date-nav-btn" id="prevWeekBtn"><i class="fas fa-chevron-left"></i> Previous Week</button>
                        <button class="date-nav-btn" id="nextWeekBtn">Next Week <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <!-- Redesigned Detail Metrics Grid -->
                <div class="detail-metrics">
                    <!-- Schedule Attainment Card (Smaller) -->
                    <div class="detail-metric-card schedule-card">
                        <div class="detail-metric-header">Schedule Attainment</div>
                        <div class="toggle-container">
                            <button class="toggle-btn active" id="attainmentPercentBtn">% View</button>
                            <button class="toggle-btn" id="attainmentBoxesBtn">Boxes</button>
                            <button class="toggle-btn" id="attainmentDevicesBtn">Devices</button>
                        </div>
                        <div class="chart-container" id="scheduleAttainmentChart"></div>
                    </div>
                    
                    <!-- Labour Cost Card (Smaller) -->
                    <div class="detail-metric-card labour-card">
                        <div class="detail-metric-header">Labour Cost per Unit</div>
                        <div class="toggle-container">
                            <button class="toggle-btn active" id="labourCostBtn">Labour Cost</button>
                            <button class="toggle-btn" id="unitCostBtn">Cost Per Unit</button>
                        </div>
                        <div class="chart-container" id="labourCostChart"></div>
                    </div>
                    <!-- Scrap Analysis Card (Larger) -->
                    <div class="detail-metric-card scrap-card">
                        <div class="detail-metric-header">Scrap Analysis</div>
                        <div class="toggle-container">
                            <button class="toggle-btn active" id="scrapQtyBtn">By Quantity</button>
                            <button class="toggle-btn" id="scrapCostBtn">By Cost</button>
                        </div>
                        <div class="scrap-analysis-layout">
                            <!-- Trend line chart (smaller) -->
                            <div class="scrap-trend-chart">
                                <div class="chart-subtitle">Scrap % Trend</div>
                                <div id="scrapPercentageChart"></div>
                            </div>
                            
                            <!-- Daily scrap details grid -->
                            <div class="daily-scrap-container">
                                <div id="dailyScrapGrid" class="daily-scrap-grid">
                                    <!-- Daily scrap cards will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Downtime Analysis Card -->
                    <div class="detail-metric-card downtime-card">
                        <div class="detail-metric-header">Downtime Analysis</div>
                        <div class="toggle-container">
                            <button class="toggle-btn active" id="downtimeReasonBtn">Reason</button>
                            <button class="toggle-btn" id="downtimeMachineBtn">Machine</button>
                            <button class="toggle-btn" id="downtimeDurationBtn">Duration</button>
                        </div>
                        <div class="chart-container" id="downtimeChart">
                            <!-- Downtime chart will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ======================================
         * CONFIGURATION
         * ======================================
         */
        
        // Main configuration object for the dashboard
        const CONFIG = {
            // URL to fetch operational data from
            dataUrl: 'OpsData.json',
            
            // Refresh interval in milliseconds (5 minutes)
            refreshInterval: 5 * 60 * 1000,
            
            // Default period for data display
            defaultPeriod: 'weekly', // Changed from 'daily' to 'weekly'
            
            // Default date range (last 5 production dates)
            defaultDateRange: {
                days: 7  // Changed from 5 to 7 days (one week)
            },
            
            // Debug mode to show the debug log
            debugMode: true,
            
            // Production lines that need special handling for Base Products
            specialLinesBaseProducts: {
                'nosi-scalpel': true,
                'mvokwe-3rd line': true
            },
            
            // Variant timeline colors
            timelineColors: {
                'default': 'var(--timeline-blue)',
                'XL': 'var(--timeline-orange)',
                'S10': 'var(--timeline-red)',
                'S20': 'var(--timeline-blue)',
                'Plus': 'var(--timeline-purple)',
                'Regular': 'var(--timeline-blue)',
                'Deluxe': 'var(--timeline-purple)',
                'Standard': 'var(--timeline-blue)'
            },
            
            // Thresholds for KPI color coding
            thresholds: {
                scheduleAttainment: {
                    good: 95,      // >= 95% = green
                    warning: 85    // >= 85% = yellow, < 85% = red
                },
                labourCostPerUnit: {
                    good: 300,     // <= 300 = green
                    warning: 400   // <= 400 = yellow, > 400 = red
                },
                scrapPercentage: {
                    good: 5,       // <= 5% = green
                    warning: 15    // <= 15% = yellow, > 15% = red
                },
                downtimeHours: {
                    good: 3,       // <= 3 hours = green
                    warning: 6     // <= 6 hours = yellow, > 6 hours = red
                }
            }
        };
        /**
         * ======================================
         * LOGGING UTILITIES
         * ======================================
         */
        
        /**
         * Debug logger for diagnostic information
         */
        const Logger = {
            logElement: null,
            
            /**
             * Initialize the logger
             */
            init: function() {
                this.logElement = document.getElementById('debugLog');
                if (CONFIG.debugMode) {
                    this.logElement.style.display = 'block';
                }
            },
            
            /**
             * Log an information message
             * @param {string} message - The message to log
             */
            info: function(message) {
                this._log(message, 'info');
            },
            
            /**
             * Log a warning message
             * @param {string} message - The message to log
             */
            warn: function(message) {
                this._log(message, 'warning');
            },
            
            /**
             * Log an error message
             * @param {string} message - The message to log
             * @param {Error} [error] - Optional error object
             */
            error: function(message, error) {
                let fullMessage = message;
                if (error) {
                    fullMessage += `: ${error.message}`;
                }
                this._log(fullMessage, 'error');
                if (error && error.stack) {
                    this._log(`Stack: ${error.stack}`, 'error');
                }
            },
            
            /**
             * Internal method to add a log entry
             * @param {string} message - The message to log
             * @param {string} level - The log level ('info', 'warning', 'error')
             * @private
             */
            _log: function(message, level) {
                if (!this.logElement) return;
                
                const timestamp = new Date().toISOString();
                const entry = document.createElement('div');
                entry.className = `debug-log-entry ${level}`;
                entry.textContent = `[${timestamp}] ${message}`;
                
                this.logElement.appendChild(entry);
                this.logElement.scrollTop = this.logElement.scrollHeight;
                
                // Also log to console
                switch(level) {
                    case 'info':
                        console.log(message);
                        break;
                    case 'warning':
                        console.warn(message);
                        break;
                    case 'error':
                        console.error(message);
                        break;
                }
            }
        };

        /**
         * ======================================
         * DATE UTILITIES
         * ======================================
         */
        
        // Store current date range
        let currentDateRange = {
            start: null,
            end: null
        };
        
        // Store current period type
        let currentPeriod = CONFIG.defaultPeriod;
        
        // Store week cycle preference (0-6, where 0 is Sunday, 1 is Monday, etc.)
        let weekCycleStartDay = 1; // Default to Monday

        /**
         * Gets the default date range based on week cycle preference
         * @returns {Object} Object with start and end dates
         */
        function getDefaultDateRange() {
            const now = new Date();
            
            // Get current day of week (0-6, where 0 is Sunday)
            const currentDay = now.getDay();
            
            // Calculate days to subtract to get to the start day
            const daysToSubtract = (currentDay - weekCycleStartDay + 7) % 7;
            
            // Calculate start date (the selected start day of the current/most recent week)
            const start = new Date(now);
            start.setDate(start.getDate() - daysToSubtract);
            start.setHours(0, 0, 0, 0);
            
            // Calculate end date (start + 6 days to complete the week)
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            end.setHours(23, 59, 59, 999);
            
            return {
                start: start.toISOString().split('T')[0],
                end: end.toISOString().split('T')[0]
            };
        }

        /**
         * Sets the date inputs to the current date range values
         */
        function setDateInputs() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (currentDateRange.start) {
                startDateInput.value = currentDateRange.start.split('T')[0];
            }
            
            if (currentDateRange.end) {
                endDateInput.value = currentDateRange.end.split('T')[0];
            }
        }

        function navigateToPreviousWeek() {
            Logger.info('Navigating to previous week');
            
            const start = new Date(detailViewState.dateRange.start);
            const end = new Date(detailViewState.dateRange.end);
            
            // Move both dates back by 7 days
            start.setDate(start.getDate() - 7);
            end.setDate(end.getDate() - 7);
            
            // Update both the detail view state and the main page state
            detailViewState.dateRange.start = start.toISOString().split('T')[0];
            detailViewState.dateRange.end = end.toISOString().split('T')[0];
            
            // Also update the main date range
            currentDateRange.start = detailViewState.dateRange.start;
            currentDateRange.end = detailViewState.dateRange.end;
            
            // Update displays and reload data
            updateModalDateRange();
            updateDateRangeDisplay(currentDateRange);
            loadDetailViewData();
        }
        
        /**
         * Navigates to the previous period
         */
        function navigateToPreviousPeriod() {
            Logger.info('Navigating to previous period: ' + currentPeriod);
            
            const start = new Date(currentDateRange.start);
            const end = new Date(currentDateRange.end);
            
            switch(currentPeriod) {
                case 'daily':
                    // Move back one day
                    start.setDate(start.getDate() - 1);
                    end.setDate(end.getDate() - 1);
                    break;
                case 'weekly':
                    // Move back one week
                    start.setDate(start.getDate() - 7);
                    end.setDate(end.getDate() - 7);
                    break;
                case 'monthly':
                    // Move back one month
                    start.setMonth(start.getMonth() - 1);
                    end.setMonth(end.getMonth() - 1);
                    break;
            }
            
            // Update date range
            currentDateRange.start = start.toISOString().split('T')[0];
            currentDateRange.end = end.toISOString().split('T')[0];
            
            // Reload dashboard
            initializeDashboard();
        }
        
        /**
         * Navigates to the next period
         */
        function navigateToNextPeriod() {
            Logger.info('Navigating to next period: ' + currentPeriod);
            
            const start = new Date(currentDateRange.start);
            const end = new Date(currentDateRange.end);
            
            switch(currentPeriod) {
                case 'daily':
                    // Move forward one day
                    start.setDate(start.getDate() + 1);
                    end.setDate(end.getDate() + 1);
                    break;
                case 'weekly':
                    // Move forward one week
                    start.setDate(start.getDate() + 7);
                    end.setDate(end.getDate() + 7);
                    break;
                case 'monthly':
                    // Move forward one month
                    start.setMonth(start.getMonth() + 1);
                    end.setMonth(end.getMonth() + 1);
                    break;
            }
            
            // Update date range
            currentDateRange.start = start.toISOString().split('T')[0];
            currentDateRange.end = end.toISOString().split('T')[0];
            
            // Reload dashboard
            initializeDashboard();
        }
        /**
         * Stores user preferences in localStorage
         */
        function storeUserPreferences() {
            try {
                const preferences = {
                    weekCycleStartDay: weekCycleStartDay,
                    period: currentPeriod
                };
                
                localStorage.setItem('dashboardPreferences', JSON.stringify(preferences));
                Logger.info('Stored user preferences: ' + JSON.stringify(preferences));
            } catch (error) {
                Logger.error('Error storing user preferences', error);
            }
        }
        
        /**
         * Loads user preferences from localStorage
         */
        function loadUserPreferences() {
            try {
                const preferencesString = localStorage.getItem('dashboardPreferences');
                
                if (preferencesString) {
                    const preferences = JSON.parse(preferencesString);
                    
                    // Set week cycle start day if defined
                    if (preferences.weekCycleStartDay !== undefined) {
                        weekCycleStartDay = preferences.weekCycleStartDay;
                        // Update dropdown
                        const cycleStartSelect = document.getElementById('cycleStartDay');
                        if (cycleStartSelect) {
                            cycleStartSelect.value = weekCycleStartDay.toString();
                        }
                    }
                    
                    // Set period if defined
                    if (preferences.period) {
                        currentPeriod = preferences.period;
                        // Update button text
                        const periodToggle = document.getElementById('periodToggle');
                        if (periodToggle) {
                            periodToggle.textContent = currentPeriod.charAt(0).toUpperCase() + currentPeriod.slice(1);
                        }
                    }
                    
                    Logger.info('Loaded user preferences: ' + JSON.stringify(preferences));
                }
            } catch (error) {
                Logger.error('Error loading user preferences', error);
            }
        }

        /**
         * ======================================
         * EVENT HANDLERS
         * ======================================
         */

        /**
         * Handles period toggle button click
         * @param {Event} e - The click event
         */
        function handlePeriodToggle(e) {
            const btn = e.target;
            // Toggle between Weekly/Monthly/Daily
            if (btn.textContent === 'Weekly') {
                btn.textContent = 'Monthly';
                currentPeriod = 'monthly';
                Logger.info('Switched to Monthly view');
            } else if (btn.textContent === 'Monthly') {
                btn.textContent = 'Daily';
                currentPeriod = 'daily';
                Logger.info('Switched to Daily view');
            } else {
                btn.textContent = 'Weekly';
                currentPeriod = 'weekly';
                Logger.info('Switched to Weekly view');
            }
            
            // Store the user preference
            storeUserPreferences();
            
            // Reload dashboard with new period setting
            initializeDashboard();
        }

        /**
         * Handles refresh button click
         */
        function handleRefresh() {
            Logger.info('Manual refresh requested');
            initializeDashboard();
        }

        /**
         * Handles date range button click
         */
        function handleDateRangeButton() {
            Logger.info('Date range button clicked');
            const dropdown = document.getElementById('datePickerDropdown');
            dropdown.classList.toggle('show');
            
            // Set date inputs to current values
            setDateInputs();
        }

        /**
         * Handles apply date range button click
         */
        function handleApplyDateRange() {
            Logger.info('Apply date range button clicked');
            
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            // Validate inputs
            if (!startDateInput.value || !endDateInput.value) {
                Logger.warn('Invalid date range inputs');
                return;
            }
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            // Validate date range
            if (startDate > endDate) {
                Logger.warn('Start date cannot be after end date');
                alert('Start date cannot be after end date');
                return;
            }
            
            // Update current date range
            currentDateRange.start = startDateInput.value;
            currentDateRange.end = endDateInput.value;
            
            // Hide dropdown
            document.getElementById('datePickerDropdown').classList.remove('show');
            
            // Reload dashboard with new date range
            initializeDashboard();
        }

        /**
         * Handles 'Apply & Remember' button click
         */
        function handleApplyAndRememberCycle() {
            Logger.info('Apply and remember cycle button clicked');
            
            // Get selected cycle
            const cycleStartSelect = document.getElementById('cycleStartDay');
            const selectedCycle = parseInt(cycleStartSelect.value);
            
            // Update cycle preference
            weekCycleStartDay = selectedCycle;
            
            // Store preference in localStorage
            storeUserPreferences();
            
            // Apply date range
            handleApplyDateRange();
        }

        /**
         * Handles document click to close date picker dropdown
         * @param {Event} e - The click event
         */
        function handleDocumentClick(e) {
            const dropdown = document.getElementById('datePickerDropdown');
            const dateRangeButton = document.getElementById('dateRangeButton');
            
            // Close dropdown if click is outside the dropdown and button
            if (dropdown.classList.contains('show') && 
                !dropdown.contains(e.target) && 
                e.target !== dateRangeButton) {
                dropdown.classList.remove('show');
            }
        }

        /**
         * Track current detail view state
         */
        const detailViewState = {
            lineId: null,
            dateRange: {
                start: null,
                end: null
            },
            attainmentView: 'percent',  // New: 'percent', 'boxes', or 'devices'
            scrapView: 'qty',           // 'qty' or 'cost'
            downtimeView: 'reason',     // 'reason', 'machine', or 'duration'
            costView: 'labour',         // 'labour' or 'unit'
            filteredData: null          // Store filtered data for reuse
        };

        /**
         * NEW IMPLEMENTATION: Schedule Attainment Chart with toggle for % view, boxes actual vs target, or devices actual vs target
         * @param {Array} data - Filtered data for the line
         * @param {string} view - The view to display ('percent', 'boxes', or 'devices')
         */
        function renderScheduleAttainmentChart(data, view = 'percent') {
            const chartContainer = document.getElementById('scheduleAttainmentChart');
            if (!chartContainer) {
                Logger.error("Schedule attainment chart container not found");
                return;
            }
            
            // Sort data by date
            const sortedData = [...data].sort((a, b) => new Date(a.Date) - new Date(b.Date));
            
            let html = '<div style="width: 100%; height: 100%;">';
            
            // Create chart based on view type
            if (view === 'percent') {
                // Percentage view implementation
                const chartData = sortedData.map(record => ({
                    date: new Date(record.Date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}),
                    value: parseFloat(record['Schedule Attainment'] || 0)
                }));
                
                // Create container with Y-axis
                html += '<div style="display: flex; height: 100%;">';
                
                // Y-axis with scaled labels
                html += '<div style="width: 30px; height: 100%; display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end; padding-right: 5px; color: var(--text-light); font-size: 9px;">';
                html += '<div>100%</div>';
                html += '<div>50%</div>';
                html += '<div>0%</div>';
                html += '</div>';
                
                // Chart area
                html += '<div style="flex-grow: 1; height: 100%; display: flex; flex-direction: column;">';
                
                // Chart bars
                html += '<div style="flex-grow: 1; display: flex; align-items: flex-end; gap: 2px; padding-top: 5px;">';
                
                // Create bars for each day
                chartData.forEach(item => {
                    const height = Math.min(item.value, 100);
                    
                    html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <div style="font-size: 8px; color: var(--text-light); height: 15px;">${item.value.toFixed(1)}%</div>
                        <div style="width: 60%; height: ${height}%; background-color: var(--primary-blue);"></div>
                        <div style="font-size: 8px; color: var(--text-light); margin-top: 3px;">${item.date}</div>
                    </div>
                    `;
                });
                
                html += '</div>'; // End chart bars
                html += '</div>'; // End chart area
                html += '</div>'; // End container with Y-axis
            } 
            else if (view === 'boxes' || view === 'devices') {
                // Boxes or Devices view implementation (actual vs target)
                const chartData = sortedData.map(record => {
                    const field = view === 'boxes' ? 'Boxes' : 'Devices';
                    const actual = parseInt(record[`Actual ${field} Produced`] || 0);
                    const target = parseInt(record[`Theoretical Target (${field})`] || 0);
                    
                    return {
                        date: new Date(record.Date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}),
                        actual: actual,
                        target: target
                    };
                });
                
                // Find max target value for scaling
                const maxTarget = Math.max(...chartData.map(item => item.target), 1);
                
                // Create container with Y-axis
                html += '<div style="display: flex; height: 100%;">';
                
                // Y-axis with scaled labels
                html += '<div style="width: 30px; height: 100%; display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end; padding-right: 5px; color: var(--text-light); font-size: 9px;">';
                html += `<div>${maxTarget}</div>`;
                html += `<div>${Math.round(maxTarget/2)}</div>`;
                html += '<div>0</div>';
                html += '</div>';
                
                // Chart area
                html += '<div style="flex-grow: 1; height: 100%; display: flex; flex-direction: column;">';
                
                // Chart bars
                html += '<div style="flex-grow: 1; display: flex; align-items: flex-end; gap: 2px; padding-top: 5px;">';
                
                // Create bars for each day
                chartData.forEach(item => {
                    const heightPercentage = maxTarget > 0 ? (item.actual / maxTarget * 100) : 0;
                    const targetHeightPercentage = maxTarget > 0 ? (item.target / maxTarget * 100) : 0;
                    
                    html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <div style="font-size: 8px; color: var(--text-light); height: 15px;">${item.actual}/${item.target}</div>
                        <div style="width: 60%; position: relative; height: ${Math.max(targetHeightPercentage, heightPercentage)}%;">
                            <!-- Target line -->
                            <div style="width: 100%; height: 2px; background-color: var(--danger-color); position: absolute; top: ${100 - targetHeightPercentage}%;"></div>
                            <!-- Actual bar -->
                            <div style="width: 100%; height: ${heightPercentage}%; background-color: var(--primary-blue); position: absolute; bottom: 0;"></div>
                        </div>
                        <div style="font-size: 8px; color: var(--text-light); margin-top: 3px;">${item.date}</div>
                    </div>
                    `;
                });
                
                html += '</div>'; // End chart bars
                html += '</div>'; // End chart area
                html += '</div>'; // End container with Y-axis
            }
            
            html += '</div>';
            chartContainer.innerHTML = html;
        }

        /**
         * Toggle function for schedule attainment view
         * @param {string} view - The view to switch to ('percent', 'boxes', or 'devices')
         */
        function toggleAttainmentView(view) {
            // Update active button state
            document.getElementById('attainmentPercentBtn').classList.toggle('active', view === 'percent');
            document.getElementById('attainmentBoxesBtn').classList.toggle('active', view === 'boxes');
            document.getElementById('attainmentDevicesBtn').classList.toggle('active', view === 'devices');
            
            // Store the current view in the state
            detailViewState.attainmentView = view;
            
            // Re-render the chart
            renderScheduleAttainmentChart(detailViewState.filteredData, view);
        }

        /**
         * Toggles the cost view
         * @param {string} view - The view to switch to ('labour' or 'unit')
         */
        function toggleCostView(view) {
            Logger.info(`Toggling cost view to: ${view}`);
            
            // Update the state
            detailViewState.costView = view;
            
            // Update button active states
            document.getElementById('labourCostBtn').classList.toggle('active', view === 'labour');
            document.getElementById('unitCostBtn').classList.toggle('active', view === 'unit');
            
            // Update the chart with the stored filtered data
            if (detailViewState.filteredData) {
                renderLabourCostChart(detailViewState.filteredData);
            }
        }
        
        
        /**
         * NEW IMPLEMENTATION: Scrap Analysis with trend chart and daily details
         * @param {Array} data - Filtered data for the line
         * @param {string} view - The view to display ('qty' or 'cost')
         */
        function renderScrapAnalysis(data, view = 'qty') {
            // 1. Render the trend chart
            renderScrapTrendChart(data);
            
            // 2. Render the daily scrap details
            renderDailyScrapDetails(data, view);
        }

        /**
         * Render the scrap percentage trend chart
         * @param {Array} data - Filtered data for the line
         */
        function renderScrapTrendChart(data) {
            const container = document.getElementById('scrapPercentageChart');
            if (!container) return;
            
            // Sort data by date
            const sortedData = [...data].sort((a, b) => new Date(a.Date) - new Date(b.Date));
            
            // Format data for the chart
            const chartData = sortedData.map(record => ({
                date: new Date(record.Date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}),
                value: parseFloat(record['Scrap Cost as % of Production Value'] || 0)
            }));
            
            // Find maximum value for scaling
            const maxValue = Math.max(...chartData.map(item => item.value), 5); // At least 5% scale
            
            // Create SVG for the trend line
            let html = `
            <svg width="100%" height="100%" viewBox="0 0 300 50" preserveAspectRatio="none">
                <!-- Y-axis labels -->
                <text x="5" y="10" font-size="8" fill="#7f8c8d">${maxValue.toFixed(1)}%</text>
                <text x="5" y="45" font-size="8" fill="#7f8c8d">0%</text>
                
                <!-- Grid lines -->
                <line x1="25" y1="10" x2="295" y2="10" stroke="#eee" stroke-width="0.5" />
                <line x1="25" y1="45" x2="295" y2="45" stroke="#eee" stroke-width="0.5" />
                
                <!-- Trend line -->
                <polyline 
                    points="${chartData.map((item, index) => {
                        const x = 25 + (index * (270 / (chartData.length - 1 || 1)));
                        const y = 45 - ((item.value / maxValue) * 35);
                        return `${x},${y}`;
                    }).join(' ')}"
                    fill="none"
                    stroke="#e74c3c"
                    stroke-width="1.5"
                />
                
                <!-- Data points -->
                ${chartData.map((item, index) => {
                    const x = 25 + (index * (270 / (chartData.length - 1 || 1)));
                    const y = 45 - ((item.value / maxValue) * 35);
                    return `<circle cx="${x}" cy="${y}" r="2" fill="#e74c3c" />`;
                }).join('')}
            </svg>
            `;
            
            container.innerHTML = html;
        }

        /**
         * Render the daily scrap details with top reject reasons
         * @param {Array} data - Filtered data for the line
         * @param {string} view - The view to display ('qty' or 'cost')
         */
        function renderDailyScrapDetails(data, view) {
            const container = document.getElementById('dailyScrapGrid');
            if (!container) return;
            
            // Sort data by date
            const sortedData = [...data].sort((a, b) => new Date(a.Date) - new Date(b.Date));
            
            // Field selection based on view
            const rejectsField = view === 'qty' 
                ? 'Top Rejects by QTY (Reason - Station - QTY - Cost)'
                : 'Top Rejects by Cost (Reason - Station - QTY - Cost)';
            
            let html = '';
            
            // Create a card for each day
            sortedData.forEach(record => {
                const date = new Date(record.Date);
                const dateStr = date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                const scrapPercent = parseFloat(record['Scrap Cost as % of Production Value'] || 0).toFixed(1);
                
                // Extract reject reasons
                const rejectReasons = extractRejectReasons(record[rejectsField], view);
                
                // Create day card
                html += `
                <div class="daily-scrap-card">
                    <div class="daily-scrap-header">${dateStr} (${scrapPercent}%)</div>
                `;
                
                // Add top 3 reasons
                if (rejectReasons.length > 0) {
                    rejectReasons.slice(0, 3).forEach((reason, index) => {
                        html += `<div class="scrap-reason" title="${reason}">${index + 1}. ${reason}</div>`;
                    });
                } else {
                    html += `<div class="scrap-reason">No reject data</div>`;
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        /**
         * Helper to extract reject reasons
         * @param {string} rejectsText - The text containing reject reasons
         * @param {string} view - The view to display ('qty' or 'cost')
         * @returns {Array} Array of formatted reject reason strings
         */
        function extractRejectReasons(rejectsText, view) {
            if (!rejectsText || rejectsText.includes('No rejects')) return [];
            
            const reasons = [];
            const entries = rejectsText.split('|');
            
            entries.forEach(entry => {
                const parts = entry.trim().split(' - ');
                if (parts.length >= 3) {
                    // Extract reason (remove numbering)
                    let reason = parts[0].trim().replace(/^\d+\.\s+/, '');
                    
                    // Extract station
                    const station = parts[1].trim();
                    
                    // Extract value based on view (QTY or Cost)
                    let value = '';
                    if (view === 'qty') {
                        // Find the QTY part
                        for (let i = 2; i < parts.length; i++) {
                            if (parts[i].includes('QTY:')) {
                                value = parts[i].replace('QTY:', '').trim() + ' QTY';
                                break;
                            }
                        }
                    } else {
                        // Find the Cost part
                        for (let i = 2; i < parts.length; i++) {
                            if (parts[i].includes('Cost:')) {
                                value = 'R ' + parts[i].replace('Cost:', '').trim();
                                break;
                            }
                        }
                    }
                    
                    reasons.push(`${reason} - ${station} - ${value}`);
                }
            });
            
            return reasons;
        }
        // First, define these functions at the top of your script section
function showDetailView(lineId) {
    // Store the current line ID
    detailViewState.lineId = lineId;
    
    // Use the date range from the main page
    detailViewState.dateRange.start = currentDateRange.start;
    detailViewState.dateRange.end = currentDateRange.end;
    
    // Update modal title
    const lineElement = document.querySelector(`[data-line-id="${lineId}"]`);
    if (lineElement) {
        const headerElement = lineElement.querySelector('.card-title');
        if (headerElement) {
            document.getElementById('modalTitle').textContent = headerElement.textContent + ' Details';
        }
    }
    
    // Update date range display
    updateModalDateRange();
    
    // Load and render the charts
    loadDetailViewData();
    
    // Show the modal
    document.getElementById('detailModal').classList.add('show');
}

function hideDetailView() {
    document.getElementById('detailModal').classList.remove('show');
}


        /**
         * NEW IMPLEMENTATION: Downtime Analysis Chart with reason/machine labels
         * @param {Array} data - Filtered data for the line
         * @param {string} view - The view to display ('reason', 'machine', or 'duration')
         */
        function renderDowntimeChart(data, view = 'reason') {
            const container = document.getElementById('downtimeChart');
            if (!container) return;
            
            // Sort data by date
            const sortedData = [...data].sort((a, b) => new Date(a.Date) - new Date(b.Date));
            
            // Extract downtime data
            const downtimeData = sortedData.map(record => {
                const date = new Date(record.Date);
                const dateStr = date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                const minutes = parseFloat(record['Downtime Duration (min)'] || 0);
                const hours = minutes / 60;
                
                // Extract reason and machine
                let reason = 'No downtime';
                let machine = '';
                
                // Get from downtime field
                const downtimeField = 'Top Downtime by Cost (Reason - Machine - Cost - Downtime Min)';
                
                if (record[downtimeField] && !record[downtimeField].includes('No downtime') && minutes > 0) {
                    const entries = record[downtimeField].split('|');
                    
                    if (entries.length > 0) {
                        const entry = entries[0].trim();
                        const parts = entry.split(' - ');
                        
                        if (parts.length >= 2) {
                            reason = parts[0].trim().replace(/^\d+\.\s+/, '');
                            machine = parts[1].trim();
                        }
                    }
                }
                
                return {
                    date: dateStr,
                    hours: hours,
                    reason: reason,
                    machine: machine
                };
            });
            
            // Find max for scaling
            const maxHours = Math.max(...downtimeData.map(item => item.hours), 1); // At least 1 hour scale
            
            // Create the chart HTML
            let html = '<div style="display: flex; height: 100%; align-items: flex-end;">';
            
            // Create a bar for each day
            downtimeData.forEach(item => {
                // Calculate height as percentage of max
                const height = (item.hours / maxHours) * 80; // Max 80% of container height
                
                // Determine bar color based on duration
                let barColor = 'var(--primary-blue)';
                if (item.hours > 2) {
                    barColor = 'var(--danger-color)';
                } else if (item.hours > 1) {
                    barColor = 'var(--warning-color)';
                }
                
                // Determine label based on view
                let label = '';
                switch(view) {
                    case 'reason':
                        label = item.reason;
                        break;
                    case 'machine':
                        label = item.machine;
                        break;
                    case 'duration':
                        label = `${item.reason} - ${item.machine}`;
                        break;
                }
                
                html += `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center;">
                    <div class="downtime-label" title="${label}">${label}</div>
                    <div style="width: 70%; height: ${height}px; background-color: ${barColor}; display: flex; justify-content: center; align-items: center;">
                        <span style="font-size: 9px; color: white;">${item.hours.toFixed(1)}h</span>
                    </div>
                    <div style="font-size: 8px; color: var(--text-light); margin-top: 3px;">${item.date}</div>
                </div>
                `;
            });
            
            html += '</div>';
            
            container.innerHTML = html;
        }

        /**
         * Updated toggle functions for detail view
         */
        function toggleScrapView(view) {
            // Update active button states
            document.getElementById('scrapQtyBtn').classList.toggle('active', view === 'qty');
            document.getElementById('scrapCostBtn').classList.toggle('active', view === 'cost');
            
            // Store the current view in the state
            detailViewState.scrapView = view;
            
            // Re-render the scrap analysis (only the daily details change)
            renderDailyScrapDetails(detailViewState.filteredData, view);
        }

        function toggleDowntimeView(view) {
            // Update active button states
            document.getElementById('downtimeReasonBtn').classList.toggle('active', view === 'reason');
            document.getElementById('downtimeMachineBtn').classList.toggle('active', view === 'machine');
            document.getElementById('downtimeDurationBtn').classList.toggle('active', view === 'duration');
            
            // Store the current view in the state
            detailViewState.downtimeView = view;
            
            // Re-render the chart
            renderDowntimeChart(detailViewState.filteredData, view);
        }

        /**
         * Updated loadDetailViewData function to use the new rendering methods
         */
        function loadDetailViewData() {
            Logger.info(`Loading detail view data for line: ${detailViewState.lineId}`);
            
            // Get the filtered data for the line and date range
            const filteredData = getFilteredLineData(detailViewState.lineId, detailViewState.dateRange.start, detailViewState.dateRange.end);
            
            Logger.info(`Retrieved ${filteredData.length} records for line ${detailViewState.lineId}`);
            
            // Store the filtered data for reuse
            detailViewState.filteredData = filteredData;
            
            if (filteredData.length === 0) {
                Logger.warn(`No data available for line ${detailViewState.lineId} in selected date range`);
                showNoDataMessage();
                return;
            }
            
            try {
                // Initialize views if not set
                detailViewState.attainmentView = detailViewState.attainmentView || 'percent';
                detailViewState.costView = detailViewState.costView || 'labour';
                detailViewState.scrapView = detailViewState.scrapView || 'qty';
                detailViewState.downtimeView = detailViewState.downtimeView || 'reason';
                
                // Render all sections with current views
                renderScheduleAttainmentChart(filteredData, detailViewState.attainmentView);
                renderLabourCostChart(filteredData, detailViewState.costView);
                renderScrapAnalysis(filteredData, detailViewState.scrapView);
                renderDowntimeChart(filteredData, detailViewState.downtimeView);
                
            } catch (error) {
                Logger.error(`Error rendering charts: ${error.message}`, error);
                showNoDataMessage();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load user preferences
            loadUserPreferences();
            
            // Update cycle dropdown to match stored preference
            document.getElementById('cycleStartDay').value = weekCycleStartDay.toString();
            
            // Add event listeners for main dashboard buttons
            document.getElementById('periodToggle').addEventListener('click', handlePeriodToggle);
            document.getElementById('refreshButton').addEventListener('click', handleRefresh);
            document.getElementById('dateRangeButton').addEventListener('click', handleDateRangeButton);
            document.getElementById('applyDateRange').addEventListener('click', handleApplyDateRange);
            document.getElementById('applyAndRememberCycle').addEventListener('click', handleApplyAndRememberCycle);
            document.getElementById('prevPeriodButton').addEventListener('click', navigateToPreviousPeriod);
            document.getElementById('nextPeriodButton').addEventListener('click', navigateToNextPeriod);
            
            // Add event listener for document click (to close dropdown)
            document.addEventListener('click', handleDocumentClick);
            
            // Detail view event listeners
            document.getElementById('modalClose').addEventListener('click', hideDetailView);
            document.getElementById('prevWeekBtn').addEventListener('click', navigateToPreviousWeek);
            document.getElementById('nextWeekBtn').addEventListener('click', navigateToNextWeek);
            
            // Schedule Attainment toggle buttons
            document.getElementById('attainmentPercentBtn').addEventListener('click', () => toggleAttainmentView('percent'));
            document.getElementById('attainmentBoxesBtn').addEventListener('click', () => toggleAttainmentView('boxes'));
            document.getElementById('attainmentDevicesBtn').addEventListener('click', () => toggleAttainmentView('devices'));
            
            // Scrap Analysis toggle buttons
            document.getElementById('scrapQtyBtn').addEventListener('click', () => toggleScrapView('qty'));
            document.getElementById('scrapCostBtn').addEventListener('click', () => toggleScrapView('cost'));
            
            // Downtime Analysis toggle buttons
            document.getElementById('downtimeReasonBtn').addEventListener('click', () => toggleDowntimeView('reason'));
            document.getElementById('downtimeMachineBtn').addEventListener('click', () => toggleDowntimeView('machine'));
            document.getElementById('downtimeDurationBtn').addEventListener('click', () => toggleDowntimeView('duration'));
            
            // Labour Cost toggle buttons
            document.getElementById('labourCostBtn').addEventListener('click', () => toggleCostView('labour'));
            document.getElementById('unitCostBtn').addEventListener('click', () => toggleCostView('unit'));
            
            initializeDashboard();
            
            // Set up auto-refresh interval
            setInterval(initializeDashboard, CONFIG.refreshInterval);
        });

        // Make functions available in the global scope
        window.showDetailView = showDetailView;
        window.hideDetailView = hideDetailView;
        window.toggleAttainmentView = toggleAttainmentView;
        window.toggleScrapView = toggleScrapView;
        window.toggleDowntimeView = toggleDowntimeView;
        window.toggleCostView = toggleCostView;
    </script>
</body>
</html>
